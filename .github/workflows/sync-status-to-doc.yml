# ============================================================================
# Source Repo â†’ Doc Repo ìƒíƒœ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš°
# ============================================================================
# ì´ íŒŒì¼ì„ Source Repoì˜ .github/workflows/sync-to-doc-repo.ymlì— ë³µì‚¬í•˜ì„¸ìš”.
#
# í•„ìš”í•œ Secret:
# - DOC_REPO_TOKEN: Doc Repo ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” PAT
# ============================================================================

name: Sync Source Status to Doc Repo

on:
  issues:
    types: [labeled]
  pull_request:
    types: [closed]

env:
  DOC_REPO: dogfootman/aiproject-doc

jobs:
  # =========================================================================
  # ìë™í™” B: Source in-progress â†’ Doc impl-started
  # =========================================================================
  impl-started-notify:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.label.name == 'in-progress'

    steps:
      - name: Find Doc Issue
        id: find-doc
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOC_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.DOC_REPO.split('/');
            const sourceIssueNumber = context.issue.number;
            const sourceRepo = context.repo.repo;

            // Doc Repoì—ì„œ Source Issue ë²ˆí˜¸ë¡œ ì—°ê²°ëœ ì´ìŠˆ ì°¾ê¸°
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'spec-complete'
            });

            const docIssue = issues.find(issue =>
              issue.body && (
                issue.body.includes(`${sourceRepo}#${sourceIssueNumber}`) ||
                issue.body.includes(`${sourceRepo}/issues/${sourceIssueNumber}`)
              )
            );

            if (docIssue) {
              core.setOutput('doc_issue_number', docIssue.number);
              console.log(`Found doc issue #${docIssue.number}`);
            } else {
              console.log('No matching doc issue found');
              core.setOutput('doc_issue_number', '');
            }

      - name: Update Doc Issue
        if: steps.find-doc.outputs.doc_issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOC_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.DOC_REPO.split('/');
            const docIssueNumber = ${{ steps.find-doc.outputs.doc_issue_number }};
            const sourceIssueUrl = '${{ github.event.issue.html_url }}';

            // spec-complete ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: docIssueNumber,
                name: 'spec-complete'
              });
            } catch (e) {
              console.log('spec-complete label not found');
            }

            // impl-started ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: docIssueNumber,
              labels: ['impl-started']
            });

            // ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: docIssueNumber,
              body: `## ğŸš€ êµ¬í˜„ ì‹œì‘ë¨

Source Repoì—ì„œ êµ¬í˜„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.

- **Source Issue**: ${sourceIssueUrl}

### ìƒíƒœ ë³€ê²½
- \`spec-complete\` â†’ \`impl-started\`

---
ğŸ¤– *ìë™ ìƒì„±ë¨*`
            });

  # =========================================================================
  # ìë™í™” C: Source PR ë¨¸ì§€ â†’ Source dev-complete, Doc impl-complete
  # =========================================================================
  pr-merged-notify:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true

    steps:
      - name: Extract Issue Number from PR
        id: extract
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          # Closes #N, Fixes #N, Resolves #N í˜•ì‹ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves)\s*#[0-9]+' | grep -oE '[0-9]+' | head -1)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Found issue number: $ISSUE_NUMBER"

      - name: Update Source Issue Labels
        if: steps.extract.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};

            // in-progress ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'in-progress'
              });
            } catch (e) {
              console.log('in-progress label not found');
            }

            // dev-complete ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['dev-complete']
            });

            // ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âœ… êµ¬í˜„ ì™„ë£Œ

PRì´ ë¨¸ì§€ë˜ì–´ êµ¬í˜„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

- **PR**: ${{ github.event.pull_request.html_url }}

### ìƒíƒœ ë³€ê²½
- \`in-progress\` â†’ \`dev-complete\`

### ë‹¤ìŒ ë‹¨ê³„
- í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ \`test-complete\` ë¼ë²¨ ì¶”ê°€

---
ğŸ¤– *ìë™ ìƒì„±ë¨*`
            });

      - name: Find and Update Doc Issue
        if: steps.extract.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOC_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.DOC_REPO.split('/');
            const sourceIssueNumber = ${{ steps.extract.outputs.issue_number }};
            const sourceRepo = context.repo.repo;
            const prUrl = '${{ github.event.pull_request.html_url }}';

            // Doc Repoì—ì„œ ì—°ê²°ëœ ì´ìŠˆ ì°¾ê¸°
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'impl-started'
            });

            const docIssue = issues.find(issue =>
              issue.body && (
                issue.body.includes(`${sourceRepo}#${sourceIssueNumber}`) ||
                issue.body.includes(`${sourceRepo}/issues/${sourceIssueNumber}`)
              )
            );

            if (docIssue) {
              // impl-started ë¼ë²¨ ì œê±°
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: docIssue.number,
                  name: 'impl-started'
                });
              } catch (e) {
                console.log('impl-started label not found');
              }

              // impl-complete ë¼ë²¨ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: docIssue.number,
                labels: ['impl-complete']
              });

              // ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: docIssue.number,
                body: `## âœ… êµ¬í˜„ ì™„ë£Œ

Source Repoì—ì„œ PRì´ ë¨¸ì§€ë˜ì–´ êµ¬í˜„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

- **PR**: ${prUrl}

### ìƒíƒœ ë³€ê²½
- \`impl-started\` â†’ \`impl-complete\`

---
ğŸ¤– *ìë™ ìƒì„±ë¨*`
              });

              console.log(`Updated doc issue #${docIssue.number}`);
            } else {
              console.log('No matching doc issue found');
            }

  # =========================================================================
  # ìë™í™” D: Source test-complete â†’ Doc verified
  # =========================================================================
  test-complete-notify:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.label.name == 'test-complete'

    steps:
      - name: Find Doc Issue
        id: find-doc
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOC_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.DOC_REPO.split('/');
            const sourceIssueNumber = context.issue.number;
            const sourceRepo = context.repo.repo;

            // Doc Repoì—ì„œ ì—°ê²°ëœ ì´ìŠˆ ì°¾ê¸°
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'impl-complete'
            });

            const docIssue = issues.find(issue =>
              issue.body && (
                issue.body.includes(`${sourceRepo}#${sourceIssueNumber}`) ||
                issue.body.includes(`${sourceRepo}/issues/${sourceIssueNumber}`)
              )
            );

            if (docIssue) {
              core.setOutput('doc_issue_number', docIssue.number);
              console.log(`Found doc issue #${docIssue.number}`);
            } else {
              console.log('No matching doc issue found');
              core.setOutput('doc_issue_number', '');
            }

      - name: Update Doc Issue
        if: steps.find-doc.outputs.doc_issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOC_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.DOC_REPO.split('/');
            const docIssueNumber = ${{ steps.find-doc.outputs.doc_issue_number }};
            const sourceIssueUrl = '${{ github.event.issue.html_url }}';

            // impl-complete ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: docIssueNumber,
                name: 'impl-complete'
              });
            } catch (e) {
              console.log('impl-complete label not found');
            }

            // verified ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: docIssueNumber,
              labels: ['verified']
            });

            // ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: docIssueNumber,
              body: `## âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ & ê²€ì¦ë¨

Source Repoì—ì„œ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì–´ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.

- **Source Issue**: ${sourceIssueUrl}

### ìƒíƒœ ë³€ê²½
- \`impl-complete\` â†’ \`verified\`

### ë‹¤ìŒ ë‹¨ê³„
- Source Issue ì¢…ë£Œ í›„ ì´ ì´ìŠˆë„ ì¢…ë£Œ

---
ğŸ¤– *ìë™ ìƒì„±ë¨*`
            });

            console.log(`Updated doc issue #${docIssueNumber} with verified label`);
