name: Sync Issue to Doc Repo

on:
  issues:
    types: [opened, labeled]

env:
  DOC_REPO: dogfootman/aiproject-doc
  SOURCE_REPO: ${{ github.repository }}

jobs:
  create-spec:
    runs-on: ubuntu-latest
    # bug, feature, enhancement ë¼ë²¨ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    if: |
      contains(github.event.issue.labels.*.name, 'bug') ||
      contains(github.event.issue.labels.*.name, 'feature') ||
      contains(github.event.issue.labels.*.name, 'enhancement')

    steps:
      - name: Checkout Doc Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DOC_REPO }}
          token: ${{ secrets.DOC_REPO_TOKEN }}
          path: doc-repo

      - name: Determine Issue Type
        id: issue-type
        run: |
          if [[ "${{ contains(github.event.issue.labels.*.name, 'bug') }}" == "true" ]]; then
            echo "type=bug" >> $GITHUB_OUTPUT
            echo "folder=bugs" >> $GITHUB_OUTPUT
            echo "prefix=BUG" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(github.event.issue.labels.*.name, 'feature') }}" == "true" ]]; then
            echo "type=feature" >> $GITHUB_OUTPUT
            echo "folder=features" >> $GITHUB_OUTPUT
            echo "prefix=FEAT" >> $GITHUB_OUTPUT
          else
            echo "type=enhancement" >> $GITHUB_OUTPUT
            echo "folder=enhancements" >> $GITHUB_OUTPUT
            echo "prefix=ENH" >> $GITHUB_OUTPUT
          fi

      - name: Extract Module from Issue Body
        id: module
        run: |
          BODY="${{ github.event.issue.body }}"
          if [[ "$BODY" == *"auth"* ]]; then
            echo "name=auth" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"user"* ]]; then
            echo "name=user" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"menu"* ]]; then
            echo "name=menu" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"board"* ]]; then
            echo "name=board" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"category"* ]]; then
            echo "name=category" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"common-code"* ]]; then
            echo "name=common-code" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"layout"* ]]; then
            echo "name=layout" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"notification"* ]]; then
            echo "name=notification" >> $GITHUB_OUTPUT
          elif [[ "$BODY" == *"settings"* ]]; then
            echo "name=settings" >> $GITHUB_OUTPUT
          else
            echo "name=general" >> $GITHUB_OUTPUT
          fi

      - name: Create Spec Document
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          TYPE="${{ steps.issue-type.outputs.type }}"
          FOLDER="${{ steps.issue-type.outputs.folder }}"
          PREFIX="${{ steps.issue-type.outputs.prefix }}"
          MODULE="${{ steps.module.outputs.name }}"
          TODAY=$(date +%Y-%m-%d)

          # íŒŒì¼ëª… ìƒì„± (íŠ¹ìˆ˜ë¬¸ì ì œê±°)
          SAFE_TITLE=$(echo "$ISSUE_TITLE" | sed 's/[^a-zA-Z0-9ê°€-í£ ]/-/g' | sed 's/  */-/g' | sed 's/--*/-/g' | head -c 50)
          SPEC_FILE="doc-repo/specs/${FOLDER}/${PREFIX}-${ISSUE_NUMBER}-${SAFE_TITLE}.md"

          # ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p "doc-repo/specs/${FOLDER}"

          # Spec ë¬¸ì„œ ìƒì„±
          cat > "$SPEC_FILE" << EOF
          # ${PREFIX}-${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ## ë©”íƒ€ ì •ë³´

          | í•­ëª© | ë‚´ìš© |
          |------|------|
          | **Source Issue** | [#${ISSUE_NUMBER}](${ISSUE_URL}) |
          | **ìœ í˜•** | ${TYPE} |
          | **ëª¨ë“ˆ** | ${MODULE} |
          | **ìƒíƒœ** | ğŸ”´ ë¶„ì„ì¤‘ |
          | **ì‘ì„±ì¼** | ${TODAY} |
          | **ì‘ì„±ì** | @${ISSUE_AUTHOR} |

          ---

          ## 1. ê°œìš”

          ### 1.1 ì›ë³¸ ì´ìŠˆ ë‚´ìš©

          ${ISSUE_BODY}

          ---

          ## 2. ë¶„ì„

          ### 2.1 í˜„ì¬ ìƒíƒœ
          <!-- í˜„ì¬ ë™ì‘ ë°©ì‹ ë˜ëŠ” ë¬¸ì œ ìƒí™© ê¸°ìˆ  -->

          ### 2.2 ì›ì¸ ë¶„ì„ (ë²„ê·¸ì˜ ê²½ìš°)
          <!-- ë²„ê·¸ ì›ì¸ ë¶„ì„ -->

          ### 2.3 ì˜í–¥ ë²”ìœ„
          <!-- ì˜í–¥ë°›ëŠ” ê¸°ëŠ¥, ëª¨ë“ˆ, í™”ë©´ ë“± -->

          ---

          ## 3. í•´ê²° ë°©ì•ˆ

          ### 3.1 ì œì•ˆ ë°©ì•ˆ
          <!-- í•´ê²°/êµ¬í˜„ ë°©ì•ˆ ê¸°ìˆ  -->

          ### 3.2 ëŒ€ì•ˆ
          <!-- ëŒ€ì•ˆì´ ìˆë‹¤ë©´ ê¸°ìˆ  -->

          ---

          ## 4. ìƒì„¸ ì„¤ê³„

          ### 4.1 API ë³€ê²½ì‚¬í•­
          <!-- API ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš° -->

          \`\`\`
          [Method] /api/endpoint
          Request: { }
          Response: { }
          \`\`\`

          ### 4.2 DB ë³€ê²½ì‚¬í•­
          <!-- DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš° -->

          ### 4.3 UI ë³€ê²½ì‚¬í•­
          <!-- UI ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš° -->

          ---

          ## 5. í…ŒìŠ¤íŠ¸ ê³„íš

          ### 5.1 í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
          - [ ] ì¼€ì´ìŠ¤ 1
          - [ ] ì¼€ì´ìŠ¤ 2

          ---

          ## 6. ì²´í¬ë¦¬ìŠ¤íŠ¸

          - [ ] ë¶„ì„ ì™„ë£Œ
          - [ ] ì„¤ê³„ ì™„ë£Œ
          - [ ] ë¦¬ë·° ì™„ë£Œ
          - [ ] Source Repo êµ¬í˜„ ì‹œì‘ ì•Œë¦¼
          EOF

          # ë“¤ì—¬ì“°ê¸° ì œê±°
          sed -i 's/^          //' "$SPEC_FILE"

          echo "SPEC_FILE=$SPEC_FILE" >> $GITHUB_ENV
          echo "SPEC_PATH=specs/${FOLDER}/${PREFIX}-${ISSUE_NUMBER}-${SAFE_TITLE}.md" >> $GITHUB_ENV

      - name: Commit and Push to Doc Repo
        working-directory: doc-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "docs: Add spec for ${{ env.SOURCE_REPO }}#${{ github.event.issue.number }}

          - Type: ${{ steps.issue-type.outputs.type }}
          - Module: ${{ steps.module.outputs.name }}
          - Source: ${{ github.event.issue.html_url }}"
          git push

      - name: Create Issue in Doc Repo
        uses: actions/github-script@v7
        id: create-doc-issue
        with:
          github-token: ${{ secrets.DOC_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.DOC_REPO.split('/');
            const issue = await github.rest.issues.create({
              owner,
              repo,
              title: `[SPEC] ${{ github.event.issue.title }}`,
              body: `## ì—°ê²°ëœ Source Issue

            - **Source**: ${{ github.event.issue.html_url }}
            - **Spec ë¬¸ì„œ**: \`${{ env.SPEC_PATH }}\`

            ## í•  ì¼

            - [ ] Spec ë¬¸ì„œ ë¶„ì„ ë‚´ìš© ì‘ì„±
            - [ ] í•´ê²° ë°©ì•ˆ ì„¤ê³„
            - [ ] ë¦¬ë·° ìš”ì²­
            - [ ] Source Repoì— êµ¬í˜„ ì‹œì‘ ì•Œë¦¼

            ---

            ### ì›ë³¸ ì´ìŠˆ ë‚´ìš©

            ${{ github.event.issue.body }}
            `,
              labels: ['spec', '${{ steps.issue-type.outputs.type }}']
            });

            core.setOutput('doc_issue_number', issue.data.number);
            core.setOutput('doc_issue_url', issue.data.html_url);

      - name: Comment on Source Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ“‹ Spec ë¬¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤

            Doc Repoì— Spec ë¬¸ì„œê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

            - **Spec ë¬¸ì„œ**: \`${{ env.SPEC_PATH }}\`
            - **Doc Issue**: ${{ steps.create-doc-issue.outputs.doc_issue_url }}

            ### ë‹¤ìŒ ë‹¨ê³„

            1. Doc Repoì—ì„œ Spec ë¬¸ì„œ ì‘ì„± ì™„ë£Œ
            2. Spec ë¦¬ë·° ë° ìŠ¹ì¸
            3. ì´ ì´ìŠˆì— \`ready-to-implement\` ë¼ë²¨ ì¶”ê°€ë¨
            4. êµ¬í˜„ ì‹œì‘

            ---
            ğŸ¤– *ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
            `
            });

      - name: Add spec-pending label
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['spec-pending']
            });
